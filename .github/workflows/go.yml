name: Go

on:
  push:
    branches: [ "main" ]

jobs:

  build-and-release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: 1.23.2
      
    - name: Install dependencies
      run: go mod download && go mod verify
        
    - name: Build
      run: env GOOS=linux GOARCH=arm64 go build -v -ldflags "-s -w" -o kiosk-client cmd/main.go

    - name: Get Latest Tag
      id: get-latest-tag
      run: echo "tag=$(git describe --tags --abbrev=0 || echo v0.0.0)" >> $GITHUB_ENV

    - name: Bump Version
      id: bump-version
      run: |
        current_version=${{ env.tag }}
        IFS='.' read -r major minor patch <<<"${current_version#v}"
        patch=$((patch + 1))
        new_version="v$major.$minor.$patch"
        echo "new_version=$new_version" >> $GITHUB_ENV
        echo "::set-output name=version::$new_version"
      shell: bash

    - name: Create GitHub Release
      uses: actions/create-release@v1
      with:
        tag_name: ${{ env.new_version }}
        release_name: ${{ env.new_version }}
        body: "Automatic release for version ${{ env.new_version }}"
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      with:
        upload_url: ${{ steps.create-release.outputs.upload_url }}
        asset_path: ./kiosk-client
        asset_name: kiosk-client
        asset_content_type: application/octet-stream
